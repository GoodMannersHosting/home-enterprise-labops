---
defaultPodOptions:
  automountServiceAccountToken: false
  enableServiceLinks: false
  restartPolicy: Always
  runtimeClassName: nvidia
  securityContext:
    fsGroup: 1000
    fsGroupChangePolicy: OnRootMismatch

controllers:
  main:
    enabled: true
    type: deployment
    replicas: 1
    revisionHistoryLimit: 2
    initContainers:
      prep-models-dir:
        image:
          repository: &repo harbor.cloud.danmanners.com/library/danmanners/comfyui
          tag: &tag v0.3.48
        command:
        - /bin/sh
        - -c
        - |
          mkdir -p /app/ComfyUI/models/checkpoints \
          /app/ComfyUI/models/clip \
          /app/ComfyUI/models/clip_vision \
          /app/ComfyUI/models/configs \
          /app/ComfyUI/models/controlnet \
          /app/ComfyUI/models/diffusers \
          /app/ComfyUI/models/diffusion_models \
          /app/ComfyUI/models/embeddings \
          /app/ComfyUI/models/gligen \
          /app/ComfyUI/models/hypernetworks \
          /app/ComfyUI/models/loras \
          /app/ComfyUI/models/photomaker \
          /app/ComfyUI/models/style_models \
          /app/ComfyUI/models/text_encoders \
          /app/ComfyUI/models/unet \
          /app/ComfyUI/models/upscale_models \
          /app/ComfyUI/models/vae \
          /app/ComfyUI/models/vae_approx
        resources:
          requests:
            cpu: "10m"
            memory: "16Mi"
          limits:
            cpu: "50m"
            memory: "64Mi"
    containers:
      core:
        ports:
        - name: http
          containerPort: &port 8188
          protocol: TCP
        image:
          repository: *repo
          tag: *tag
          pullPolicy: Always
        env:
        - name: NVIDIA_VISIBLE_DEVICES
          value: all
        - name: NVIDIA_DRIVER_CAPABILITIES
          value: all
        - name: CLI_ARGS
          value: "--verbose=DEBUG"
        resources:
          limits:
            cpu: 6
            memory: 28Gi
            nvidia.com/gpu: "1"
          requests:
            cpu: 250m
            memory: 1Gi
            nvidia.com/gpu: "1"
        lifecycle: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

service:
  core:
    enabled: true
    controller: main
    primary: true
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: *port
        targetPort: http
        protocol: TCP

persistence:
  models:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-rbd-retain
    accessMode: ReadWriteOnce
    size: 200Gi
    retain: true
    globalMounts:
    - path: /app/ComfyUI/models/
      readOnly: false
  output:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-rbd-retain
    accessMode: ReadWriteOnce
    size: 40Gi
    retain: true
    globalMounts:
    - path: /app/ComfyUI/output/
      readOnly: false
  workflows:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-rbd-retain
    accessMode: ReadWriteOnce
    size: 4Gi
    retain: true
    globalMounts:
    - path: /app/ComfyUI/user/default/workflows/
      readOnly: false
