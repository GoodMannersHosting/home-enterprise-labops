---
defaultPodOptions:
  automountServiceAccountToken: true
  enableServiceLinks: true
  restartPolicy: Always
  securityContext:
    fsGroup: 1000
    fsGroupChangePolicy: OnRootMismatch

controllers:
  api:
    enabled: true
    type: deployment
    replicas: 1
    revisionHistoryLimit: 2
    pod:
      runtimeClassName: nvidia
    containers:
      core:
        ports:
          - name: http
            containerPort: &apiPort 8000
            protocol: TCP
        image:
          repository: ghcr.io/goodmannershosting/listen-api
          tag: "sha-53b2920"
          pullPolicy: "Always"
        securityContext:
          allowPrivilegeEscalation: false
        env:
          - name: ENV
            value: "dev"
          - name: API_HOST
            value: "0.0.0.0"
          - name: API_PORT
            value: "8000"
          - name: DATABASE_URL
            value: "sqlite:////data/listen.db"
          - name: UPLOAD_DIR
            value: "/data/uploads"
          - name: RABBITMQ_USERNAME
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_USERNAME
          - name: RABBITMQ_PASSWORD
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_PASSWORD
          # Note: Ideally RABBITMQ_URL should be added to the secret with full URL: amqp://username:password@listen-rabbitmq.aiml.svc.cluster.local:5672//
          # For now, this assumes RabbitMQ service is at listen-rabbitmq.aiml.svc.cluster.local
          # The application may need to construct the URL from RABBITMQ_USERNAME/PASSWORD, or RABBITMQ_URL should be added to secrets.yaml
          - name: RABBITMQ_URL
            value: "amqp://listen-rabbitmq.aiml.svc.cluster.local:5672//"
          - name: WHISPER_MODEL
            value: "turbo"
          - name: AUDIO_CHUNK_SECONDS
            value: "15"
          - name: OPENWEBUI_URL
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: OPENWEBUI_URL
          - name: OPENWEBUI_API_KEY
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: OPENWEBUI_API_KEY
          - name: OPENWEBUI_DEFAULT_MODEL
            value: "gpt-oss:20b"
          - name: OPENWEBUI_MAX_TOKENS
            value: "65535"
          - name: OPENWEBUI_TEMPERATURE
            value: "0.7"
        resources:
          limits:
            cpu: 2
            memory: 4Gi
          requests:
            cpu: 500m
            memory: 2Gi
        lifecycle: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      worker:
        image:
          repository: ghcr.io/goodmannershosting/listen-worker
          tag: "sha-53b2920"
          pullPolicy: "Always"
        securityContext:
          allowPrivilegeEscalation: false
        command:
          - celery
          - -A
          - worker.celery_worker
          - worker
          - --loglevel=INFO
          - --concurrency=2
        env:
          - name: ENV
            value: "dev"
          - name: DATABASE_URL
            value: "sqlite:////data/listen.db"
          - name: UPLOAD_DIR
            value: "/data/uploads"
          - name: RABBITMQ_USERNAME
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_USERNAME
          - name: RABBITMQ_PASSWORD
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_PASSWORD
          - name: RABBITMQ_URL
            value: "amqp://listen-rabbitmq.aiml.svc.cluster.local:5672//"
          - name: WHISPER_MODEL
            value: "base"
          - name: AUDIO_CHUNK_SECONDS
            value: "15"
          - name: OPENWEBUI_URL
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: OPENWEBUI_URL
          - name: OPENWEBUI_API_KEY
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: OPENWEBUI_API_KEY
          - name: OPENWEBUI_DEFAULT_MODEL
            value: "gpt-oss:20b"
          - name: OPENWEBUI_MAX_TOKENS
            value: "65535"
          - name: OPENWEBUI_TEMPERATURE
            value: "0.7"
        resources:
          limits:
            cpu: 3
            memory: 8Gi
            nvidia.com/gpu: "1"
          requests:
            cpu: 500m
            memory: 2Gi
            nvidia.com/gpu: "1"
        lifecycle: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

  worker:
    enabled: false
    type: deployment
    replicas: 1
    revisionHistoryLimit: 2
    containers:
      core:
        image:
          repository: ghcr.io/goodmannershosting/listen-worker
          tag: "sha-53b2920"
          pullPolicy: "Always"
        securityContext:
          allowPrivilegeEscalation: false
        command:
          - celery
          - -A
          - worker.celery_worker
          - worker
          - --loglevel=INFO
          - --concurrency=2
        env:
          - name: ENV
            value: "dev"
          - name: DATABASE_URL
            value: "sqlite:////data/listen.db"
          - name: UPLOAD_DIR
            value: "/data/uploads"
          - name: RABBITMQ_USERNAME
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_USERNAME
          - name: RABBITMQ_PASSWORD
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_PASSWORD
          # Note: Ideally RABBITMQ_URL should be added to the secret with full URL: amqp://username:password@rabbitmq.aiml.svc.cluster.local:5672//
          # For now, this assumes RabbitMQ service is at rabbitmq.aiml.svc.cluster.local (adjust if different)
          # The application may need to construct the URL from RABBITMQ_USERNAME/PASSWORD, or RABBITMQ_URL should be added to secrets.yaml
          - name: RABBITMQ_URL
            value: "amqp://listen-rabbitmq.aiml.svc.cluster.local:5672//"
          - name: WHISPER_MODEL
            value: "base"
          - name: AUDIO_CHUNK_SECONDS
            value: "15"
          - name: OPENWEBUI_URL
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: OPENWEBUI_URL
          - name: OPENWEBUI_API_KEY
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: OPENWEBUI_API_KEY
          - name: OPENWEBUI_DEFAULT_MODEL
            value: "gpt-oss:20b"
          - name: OPENWEBUI_MAX_TOKENS
            value: "65535"
          - name: OPENWEBUI_TEMPERATURE
            value: "0.7"
        resources:
          limits:
            cpu: 3
            memory: 8Gi
            nvidia.com/gpu: "1"
          requests:
            cpu: 500m
            memory: 2Gi
            nvidia.com/gpu: "1"
        lifecycle: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

  frontend:
    enabled: true
    type: deployment
    replicas: 1
    revisionHistoryLimit: 2
    containers:
      core:
        ports:
          - name: http
            containerPort: &frontendPort 80
            protocol: TCP
        image:
          repository: ghcr.io/goodmannershosting/listen-frontend
          tag: "sha-53b2920"
          pullPolicy: "Always"
        securityContext:
          allowPrivilegeEscalation: false
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi
        lifecycle: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      oauth2-proxy:
        ports:
          - name: oauth2
            containerPort: &oauth2ProxyPort 4180
            protocol: TCP
        image:
          repository: quay.io/oauth2-proxy/oauth2-proxy
          tag: "latest"
          pullPolicy: "IfNotPresent"
        securityContext:
          allowPrivilegeEscalation: false
        args:
          - --reverse-proxy=true
          - --proxy-prefix=/oauth2
          - --set-xauthrequest=true
          - --provider=keycloak-oidc
          - --client-id=$(KEYCLOAK_CLIENT_ID)
          - --client-secret=$(KEYCLOAK_CLIENT_SECRET)
          - --oidc-issuer-url=https://keycloak.cloud.danmanners.com/realms/gmh
          - --redirect-url=https://listen.cloud.danmanners.com/oauth2/callback
          - --upstream=http://127.0.0.1:80
          - --http-address=0.0.0.0:4180
          - --code-challenge-method=S256
          - --cookie-secret=f34ca6b3b8822bc581618f375fa97187
          - --cookie-secure=true
          - --pass-user-headers=true
          - --pass-access-token=true
          - --pass-authorization-header=true
          - --email-domain=*
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        env:
          - name: KEYCLOAK_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: KEYCLOAK_CLIENT_ID
          - name: KEYCLOAK_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: KEYCLOAK_CLIENT_SECRET
        lifecycle: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

  rabbitmq:
    enabled: true
    type: deployment
    replicas: 1
    revisionHistoryLimit: 2
    containers:
      core:
        ports:
          - name: amqp
            containerPort: 5672
            protocol: TCP
          - name: management
            containerPort: 15672
            protocol: TCP
        image:
          repository: docker.io/library/rabbitmq
          tag: "4.2-management"
          pullPolicy: "IfNotPresent"
        securityContext:
          allowPrivilegeEscalation: false
        env:
          - name: RABBITMQ_DEFAULT_USER
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_USERNAME
          - name: RABBITMQ_DEFAULT_PASS
            valueFrom:
              secretKeyRef:
                name: listen-secrets
                key: RABBITMQ_PASSWORD
        resources:
          limits:
            cpu: 1
            memory: 2Gi
          requests:
            cpu: 250m
            memory: 1Gi
        lifecycle: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

configMaps:
  nginx:
    enabled: true
    data:
      default.conf: |
        server {
          listen 80;

          # Allow larger audio uploads (default is ~1MB, which triggers 413).
          client_max_body_size 512m;

          # OAuth2 Proxy endpoints
          location /oauth2/ {
            proxy_pass       http://127.0.0.1:4180;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
          }

          # Auth endpoint for auth_request
          location = /oauth2/auth {
            internal;
            proxy_pass       http://127.0.0.1:4180/oauth2/auth;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Content-Length "";
            proxy_pass_request_body off;
          }

          location / {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/start?rd=$scheme://$host$request_uri;

            root   /usr/share/nginx/html;
            index  index.html;
            try_files $uri $uri/ /index.html;
          }

          location /api/ {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/start?rd=$scheme://$host$request_uri;

            proxy_pass http://listen-api:8000/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Optional: avoid buffering big multipart uploads to disk.
            proxy_request_buffering off;
          }
        }

service:
  api:
    enabled: true
    controller: api
    primary: true
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: *apiPort
        targetPort: http
        protocol: TCP

  frontend:
    enabled: true
    controller: frontend
    primary: false
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: *frontendPort
        targetPort: http
        protocol: TCP

  rabbitmq:
    enabled: true
    controller: rabbitmq
    primary: false
    type: ClusterIP
    ports:
      amqp:
        enabled: true
        port: 5672
        targetPort: amqp
        protocol: TCP
      management:
        enabled: true
        port: 15672
        targetPort: management
        protocol: TCP

route:
  frontend:
    enabled: true
    kind: HTTPRoute
    annotations:
      external-dns.alpha.kubernetes.io/controller: "false"
      gatus.home-operations.com/enabled: "false"
    parentRefs:
      - group: gateway.networking.k8s.io
        kind: Gateway
        name: gwapi
        namespace: default
        sectionName: https-cloud
    hostnames:
      - listen.cloud.danmanners.com
    rules:
      - backendRefs:
          - name: listen-frontend
            port: *frontendPort
            weight: 1
        matches:
          - path:
              type: PathPrefix
              value: /
        timeouts:
          backendRequest: 0s
          request: 0s

rawResources:
  # Create the public Listen Web UI service
  extname:
    enabled: true
    apiVersion: v1
    kind: Service
    spec:
      metadata:
        name: listen-extname
        annotations:
          external-dns.alpha.kubernetes.io/hostname: listen.cloud.danmanners.com
          external-dns.alpha.kubernetes.io/ttl: "300"
      spec:
        type: ExternalName
        externalName: unifi-home.homelab.danmanners.com

persistence:
  nginx:
    enabled: true
    type: configMap
    name: listen
    defaultMode: 0644
    advancedMounts:
      frontend:
        core:
          - path: /etc/nginx/conf.d/default.conf
            mountPropagation: None
            readOnly: true
            subPath: default.conf

  data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-block-retain
    accessMode: ReadWriteOnce
    size: 20Gi
    retain: true
    advancedMounts:
      api:
        core:
          - path: /data
            readOnly: false
        worker:
          - path: /data
            readOnly: false

  rabbitmq-data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-block-retain
    accessMode: ReadWriteOnce
    size: 10Gi
    retain: true
    advancedMounts:
      rabbitmq:
        core:
          - path: /var/lib/rabbitmq
            readOnly: false
