---
defaultPodOptions:
  automountServiceAccountToken: false
  enableServiceLinks: true
  restartPolicy: Always
  securityContext:
    fsGroupChangePolicy: OnRootMismatch

controllers:
  backend:
    enabled: true
    type: statefulset
    replicas: 1
    revisionHistoryLimit: 2
    initContainers:
      create-storage-dirs:
        image:
          repository: "docker.io/library/busybox"
          tag: "1.37"
        env:
          - name: ARTIFACT_KEEPER_USER_ID
            value: "999"
          - name: ARTIFACT_KEEPER_GROUP_ID
            value: "999"
        command:
          - sh
          - -c
          - |
            # Get target UID/GID from environment variables
            TARGET_UID="${ARTIFACT_KEEPER_USER_ID:-999}"
            TARGET_GID="${ARTIFACT_KEEPER_GROUP_ID:-999}"
            echo "Target ownership: $TARGET_UID:$TARGET_GID"

            # Check /data permissions
            echo "Checking /data permissions..."
            ls -la /data || true

            # Check current ownership of /data
            DATA_UID=$(stat -c "%u" /data 2>/dev/null || stat -f "%u" /data 2>/dev/null || echo "")
            DATA_GID=$(stat -c "%g" /data 2>/dev/null || stat -f "%g" /data 2>/dev/null || echo "")
            echo "Current /data ownership: $DATA_UID:$DATA_GID"

            # Set ownership of entire /data directory to target UID/GID if there's a mismatch
            if [ "$DATA_UID" != "$TARGET_UID" ] || [ "$DATA_GID" != "$TARGET_GID" ]; then
              echo "Updating ownership of /data from $DATA_UID:$DATA_GID to $TARGET_UID:$TARGET_GID (recursive)"
              chown -R "$TARGET_UID:$TARGET_GID" /data || {
                echo "ERROR: Failed to chown /data"
                exit 1
              }
            else
              echo "Ownership of /data is correct ($TARGET_UID:$TARGET_GID)"
            fi

            # Ensure /data is writable (set permissions to 755 for directories, 644 for files)
            chmod -R u+rwX,go+rX /data || {
              echo "WARNING: Failed to set permissions on /data"
            }

            # Verify /data is writable
            if [ -w /data ]; then
              echo "SUCCESS: /data is writable"
            else
              echo "ERROR: /data is NOT writable after ownership change"
              exit 1
            fi

            # Final verification
            echo "Final /data directory structure:"
            ls -la /data || true
      wait-for-db:
        image:
          repository: docker.io/library/busybox
          tag: "1.37"
        command:
          - sh
          - -c
          - |
            until nc -z -v -w30 db-rw.database.svc.cluster.local 5432
            do
              echo "Waiting for database connection..."
              sleep 5
            done
            echo "Database is up - continuing..."
      init-db:
        image:
          repository: ghcr.io/home-operations/postgres-init
          tag: "17.6"
        env:
          - name: INIT_POSTGRES_DBNAME
            value: artifact_registry
          - name: INIT_POSTGRES_HOST
            value: db-rw.database.svc.cluster.local
          - name: INIT_POSTGRES_SUPER_PASS
            valueFrom:
              secretKeyRef:
                name: db-superuser
                key: password
          - name: INIT_POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-database-credentials
                key: username
          - name: INIT_POSTGRES_PASS
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-database-credentials
                key: password
    containers:
      main:
        ports:
          - name: http
            containerPort: 8080
            protocol: TCP
        image:
          repository: &akb "ghcr.io/artifact-keeper/artifact-keeper-backend"
          tag: &akbTag "latest"
          pullPolicy: "IfNotPresent"
        securityContext:
          allowPrivilegeEscalation: false
          runAsUser: &id 999
          runAsGroup: *id
        env:
          # Database Configuration
          - name: ARTIFACT_KEEPER_DB_USER
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-database-credentials
                key: username
          - name: ARTIFACT_KEEPER_DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-database-credentials
                key: password
          - name: DATABASE_URL
            value: "postgresql://$(ARTIFACT_KEEPER_DB_USER):$(ARTIFACT_KEEPER_DB_PASSWORD)@db-rw.database.svc.cluster.local:5432/artifact_registry"
          # JWT Secret
          - name: JWT_SECRET
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-jwt-secret
                key: jwt-secret
          # Admin Password (optional, to skip first-boot setup)
          - name: ADMIN_PASSWORD
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-admin-password
                key: password
          # Server Configuration
          - name: HOST
            value: "0.0.0.0"
          - name: PORT
            value: "8080"
          # Storage Configuration
          - name: STORAGE_BACKEND
            value: "filesystem"
          - name: STORAGE_PATH
            value: "/data/storage/artifacts"
          - name: PLUGINS_DIR
            value: "/data/storage/plugins"
          # Search Integration
          - name: MEILISEARCH_URL
            value: "http://artifact-keeper-meilisearch:7700"
          - name: MEILISEARCH_API_KEY
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-meilisearch-credentials
                key: masterkey
          # Security Scanning
          - name: TRIVY_URL
            value: "http://artifact-keeper-trivy:8090"
          - name: SCAN_WORKSPACE_PATH
            value: "/data/storage/scan-workspace"
          # Logging
          - name: RUST_LOG
            value: "info,artifact_keeper=debug"
        resources:
          limits:
            cpu: 2
            memory: 4Gi
          requests:
            cpu: 250m
            memory: 512Mi
        probes:
          liveness: &backendProbes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: http
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          readiness: *backendProbes

  web:
    enabled: true
    type: deployment
    replicas: 1
    revisionHistoryLimit: 2
    containers:
      main:
        ports:
          - name: http
            containerPort: 3000
            protocol: TCP
        image:
          repository: ghcr.io/artifact-keeper/artifact-keeper-web
          tag: "latest"
          pullPolicy: "IfNotPresent"
        securityContext:
          allowPrivilegeEscalation: false
        env:
          - name: NEXT_PUBLIC_API_URL
            value: "https://registry.cloud.danmanners.com/api"
          - name: BACKEND_URL
            value: "http://artifact-keeper-backend:80"
        resources:
          limits:
            cpu: 1
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        probes:
          liveness: &webProbes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: http
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          readiness: *webProbes

  meilisearch:
    enabled: true
    type: deployment
    replicas: 1
    containers:
      main:
        ports:
          - name: http
            containerPort: 7700
            protocol: TCP
        image:
          repository: getmeili/meilisearch
          tag: "v1.12"
          pullPolicy: "IfNotPresent"
        securityContext:
          allowPrivilegeEscalation: false
        env:
          - name: MEILI_MASTER_KEY
            valueFrom:
              secretKeyRef:
                name: artifact-keeper-meilisearch-credentials
                key: masterkey
        resources:
          limits:
            cpu: 1
            memory: 2Gi
          requests:
            cpu: 250m
            memory: 512Mi
        probes:
          liveness: &meilisearchProbes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: http
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          readiness: *meilisearchProbes

  trivy:
    enabled: true
    type: deployment
    replicas: 1
    containers:
      main:
        ports:
          - name: http
            containerPort: 8090
            protocol: TCP
        image:
          repository: aquasec/trivy
          tag: "latest"
          pullPolicy: "IfNotPresent"
        securityContext:
          allowPrivilegeEscalation: false
          # runAsNonRoot: true
          # runAsUser: *id
        args:
          - server
          - --listen
          - 0.0.0.0:8090
          - --cache-dir
          - /data/.cache/trivy
        resources:
          limits:
            cpu: 1
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        probes:
          liveness: &trivyProbes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /healthz
                port: http
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          readiness: *trivyProbes

service:
  backend:
    enabled: true
    controller: backend
    primary: true
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: 80
        targetPort: http
        protocol: TCP

  web:
    enabled: true
    controller: web
    primary: false
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: 80
        targetPort: http
        protocol: TCP

  meilisearch:
    enabled: true
    controller: meilisearch
    primary: false
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: 7700
        targetPort: http
        protocol: TCP

  trivy:
    enabled: true
    controller: trivy
    primary: false
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: 8090
        targetPort: http
        protocol: TCP

  extname:
    enabled: true
    primary: false
    controller: web
    type: ExternalName
    externalName: unifi-home.homelab.danmanners.com
    annotations:
      external-dns.alpha.kubernetes.io/hostname: registry.cloud.danmanners.com
      external-dns.alpha.kubernetes.io/ttl: "300"

route:
  web:
    enabled: true
    kind: HTTPRoute
    annotations:
      external-dns.alpha.kubernetes.io/controller: "false"
      gatus.home-operations.com/enabled: "false"
      gatus.home-operations.com/endpoint: |-
        name: Artifact Keeper
        conditions:
          - "[STATUS] == 200"
        url: https://registry.cloud.danmanners.com/
        method: HEAD
    parentRefs:
      - kind: Gateway
        group: gateway.networking.k8s.io
        name: gwapi
        namespace: default
        sectionName: https-cloud
    hostnames:
      - registry.cloud.danmanners.com
    rules:
      - backendRefs:
          - name: artifact-keeper-backend
            port: 80
            weight: 1
        matches:
          - path:
              type: PathPrefix
              value: /api
        timeouts:
          backendRequest: 0s
          request: 0s
      - backendRefs:
          - name: artifact-keeper-web
            port: 80
            weight: 1
        matches:
          - path:
              type: PathPrefix
              value: /
        timeouts:
          backendRequest: 0s
          request: 0s

persistence:
  artifacts:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-block-retain
    accessMode: ReadWriteOnce
    size: 100Gi
    retain: true
    advancedMounts:
      backend:
        main:
          - path: /data
            readOnly: false
        create-storage-dirs:
          - path: /data
            readOnly: false

  meilisearch-data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-block-retain
    accessMode: ReadWriteOnce
    size: 20Gi
    retain: true
    advancedMounts:
      meilisearch:
        main:
          - path: /meili_data
            readOnly: false

  trivy-cache:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-block-retain
    accessMode: ReadWriteOnce
    size: 10Gi
    retain: true
    advancedMounts:
      trivy:
        main:
          - path: /root/.cache/trivy
            readOnly: false
  trivy-scan-workspace:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-block-retain
    accessMode: ReadWriteOnce
    size: 10Gi
    retain: true
    advancedMounts:
      trivy:
        main:
          - path: /scan-workspace
            readOnly: false
